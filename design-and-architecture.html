

<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Design and Architecture &mdash; word-def 0.2.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/css/custom.css?v=a3d76245" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js?v=b1f64a84"></script>
      <script src="_static/doctools.js?v=888ff710"></script>
      <script src="_static/sphinx_highlight.js?v=4825356b"></script>
      <script type="module" src="https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs"></script>
      <script type="module" src="https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs"></script>
      <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";import elkLayouts from "https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs";mermaid.registerLayoutLoaders(elkLayouts);mermaid.initialize({startOnLoad:false});</script>
      <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
      <script type="module">
import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";
window.addEventListener("load", () => mermaid.run());
</script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="API Reference" href="api-reference.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            word-def
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="getting-started.html">Getting started with Word Definition</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="how-to/create-a-plugin.html">How to create a word-def plugin</a></li>
<li class="toctree-l1"><a class="reference internal" href="how-to/setup-a-plugin.html">How to setup a plugin</a></li>
<li class="toctree-l1"><a class="reference internal" href="how-to/test-a-plugin.html">How to test a plugin</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api-reference.html">API Reference</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Design and Architecture</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#system-architecture">System architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="#design-notes">Design Notes</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#plugin-architecture">Plugin architecture</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#context">Context</a></li>
<li class="toctree-l4"><a class="reference internal" href="#decision">Decision</a></li>
<li class="toctree-l4"><a class="reference internal" href="#status">Status</a></li>
<li class="toctree-l4"><a class="reference internal" href="#consequences">Consequences</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#protocols-instead-of-abstract-classes">Protocols instead of Abstract Classes</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">Context</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id2">Decision</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id3">Status</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id4">Consequences</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#plugin-register-mechanism">Plugin register mechanism</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id5">Context</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id6">Decision</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id7">Status</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id8">Consequences</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#testing-the-plugin-register-mechanism">Testing the plugin register mechanism</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id9">Context</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id10">Decision</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id11">Status</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id12">Consequences</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#multi-language-plugins-register-mechanism">Multi-language plugins register mechanism</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id13">Context</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id14">Decision</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id15">Status</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id16">Consequences</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">word-def</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Design and Architecture</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/design-and-architecture.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="design-and-architecture">
<h1>Design and Architecture<a class="headerlink" href="#design-and-architecture" title="Permalink to this heading"></a></h1>
<section id="system-architecture">
<h2>System architecture<a class="headerlink" href="#system-architecture" title="Permalink to this heading"></a></h2>
<p>In the diagram below, the <code class="docutils literal notranslate"><span class="pre">word-def-plugin-core</span></code> is a virtual namespace. The two
classes contained within it are protocols defined in the <code class="docutils literal notranslate"><span class="pre">word-def</span></code> package.</p>
<pre  class="mermaid">
        classDiagram
    namespace word-def-plugin-core{
        class Plugin
        class PluginFactory
    }

    namespace word-def-plugin-english-collins{
        class Adapter_en[&quot;Adapter&quot;]
        class AdapterFactory_en[&quot;AdapterFactory&quot;]
    }

    namespace word-def-plugin-italian-pons{
        class Adapter_it[&quot;Adapter&quot;]
        class AdapterFactory_it[&quot;AdapterFactory&quot;]
    }

    namespace word-def{
        class get_definition
        class get_synonyme
        class get_usage_examples
    }


    Adapter_en &lt;|.. Plugin
    AdapterFactory_en &lt;|-- PluginFactory
    Adapter_it &lt;|.. Plugin
    AdapterFactory_it &lt;|-- PluginFactory

    Plugin
    &lt;&lt;interface&gt;&gt; Plugin
    Plugin: get_definition()
    Plugin: get_synonyme()
    Plugin: get_usage_examples()

    PluginFactory
    &lt;&lt;interface&gt;&gt; PluginFactory
    PluginFactory: get_language()
    PluginFactory: get_adapter()

    get_definition -- Adapter_en
    get_definition -- Adapter_it

    </pre></section>
<section id="design-notes">
<h2>Design Notes<a class="headerlink" href="#design-notes" title="Permalink to this heading"></a></h2>
<p>This document lists the design and architectural decisions taken
during the development of Word Definition. It follows
the <a class="reference external" href="https://cognitect.com/blog/2011/11/15/documenting-architecture-decisions.html">Architecture Decisions</a> format.</p>
<section id="plugin-architecture">
<h3>Plugin architecture<a class="headerlink" href="#plugin-architecture" title="Permalink to this heading"></a></h3>
<p><strong>Date: (2024-02-02)</strong></p>
<section id="context">
<h4>Context<a class="headerlink" href="#context" title="Permalink to this heading"></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">word-def</span></code> package contains the backbone of a plugin architecture. The <code class="docutils literal notranslate"><span class="pre">word-def</span></code>
package defines the protocols to be implemented by plugins.</p>
<ol class="arabic simple">
<li><p>Plugin</p></li>
<li><p>PluginFactory</p></li>
</ol>
<p>The entry point for plugins is the <code class="docutils literal notranslate"><span class="pre">AdapterFactory</span></code> class, which every plugin
must define. This class follows the <code class="docutils literal notranslate"><span class="pre">PluginFactory</span></code> protocol, and its goal is
to instantiate implementations of <code class="docutils literal notranslate"><span class="pre">Plugin</span></code> and provide an interface to their
metadata.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">word-def</span></code> plugin register will attempt to load any Python modules
installed at <code class="docutils literal notranslate"><span class="pre">danoan.word_def.plugins.modules</span></code> as plugins.</p>
<div class="admonition-protocol-enforcement admonition">
<p class="admonition-title">Protocol enforcement</p>
<p><code class="docutils literal notranslate"><span class="pre">word-def</span></code> uses Python protocols, which do not enforce <code class="docutils literal notranslate"><span class="pre">is-a</span></code> relationships (as
it is the case with regular inheritance and abstract classes).</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">word-def</span></code> package can be used as a library via the <code class="docutils literal notranslate"><span class="pre">api</span></code> module or
through a <code class="docutils literal notranslate"><span class="pre">cli</span></code>. A plugin is installed like any other python package.</p>
</section>
<section id="decision">
<h4>Decision<a class="headerlink" href="#decision" title="Permalink to this heading"></a></h4>
<p>Use plugin architecture to inject functionalities into <code class="docutils literal notranslate"><span class="pre">word-def</span></code> package.</p>
</section>
<section id="status">
<h4>Status<a class="headerlink" href="#status" title="Permalink to this heading"></a></h4>
<p>Done.</p>
</section>
<section id="consequences">
<h4>Consequences<a class="headerlink" href="#consequences" title="Permalink to this heading"></a></h4>
<p>Creation of interfaces:</p>
<ol class="arabic simple">
<li><p>Plugin</p></li>
<li><p>PluginFactory</p></li>
</ol>
</section>
</section>
<section id="protocols-instead-of-abstract-classes">
<h3>Protocols instead of Abstract Classes<a class="headerlink" href="#protocols-instead-of-abstract-classes" title="Permalink to this heading"></a></h3>
<p><strong>Date: (2024-02-19)</strong></p>
<section id="id1">
<h4>Context<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h4>
<p>A plugin is a Python module that must have two classes:</p>
<ol class="arabic simple">
<li><p>One should implement the <code class="docutils literal notranslate"><span class="pre">Plugin</span></code> protocol.</p></li>
<li><p>The second one should implement the <code class="docutils literal notranslate"><span class="pre">PluginFactory</span></code> protocol.</p></li>
</ol>
<p>The use of protocols gives us a loosely coupled object compared with
abstract classes and regular inheritance. The implementations above do
not need to inherit from any class, removing a dependency.</p>
<div class="admonition-abstract-class admonition">
<p class="admonition-title">Abstract class</p>
<p>If we use abstract classes, we would have to create a package to hold
the abstract classes (e.g. <code class="docutils literal notranslate"><span class="pre">word-def-plugin-core</span></code>). Using protocols
allows us to reduce the number of packages to maintain, as the
protocols can be declared in the <code class="docutils literal notranslate"><span class="pre">word-def</span></code> package.</p>
</div>
<div class="admonition-why-to-declare-protocols admonition">
<p class="admonition-title">Why to declare protocols?</p>
<p>Since we do not have enforcement during instantiation of classes
derived from regular inheritance, why use protocols? First,
because they participate in static type checking. If we pass an
object to a function that expects protocol <code class="docutils literal notranslate"><span class="pre">P</span></code> but the object does not
implement it, an error will be raised. Second, we can take
advantage of automatic documentation generation from code to have the
protocols documented.</p>
</div>
</section>
<section id="id2">
<h4>Decision<a class="headerlink" href="#id2" title="Permalink to this heading"></a></h4>
<p>Implement <code class="docutils literal notranslate"><span class="pre">Plugin</span></code> and <code class="docutils literal notranslate"><span class="pre">PluginFactory</span></code> as protocols.</p>
</section>
<section id="id3">
<h4>Status<a class="headerlink" href="#id3" title="Permalink to this heading"></a></h4>
<p>Done.</p>
</section>
<section id="id4">
<h4>Consequences<a class="headerlink" href="#id4" title="Permalink to this heading"></a></h4>
<section id="reduced-maintenance-burden">
<h5>Reduced maintenance burden<a class="headerlink" href="#reduced-maintenance-burden" title="Permalink to this heading"></a></h5>
<p>We no longer need to create a <code class="docutils literal notranslate"><span class="pre">word-def-plugin-core</span></code> package. The
protocols are declared in the <code class="docutils literal notranslate"><span class="pre">word-def</span></code> package.</p>
</section>
<section id="plugins-depend-on-word-def-package">
<h5>Plugins depend on <code class="docutils literal notranslate"><span class="pre">word-def</span></code> package<a class="headerlink" href="#plugins-depend-on-word-def-package" title="Permalink to this heading"></a></h5>
<p>At first glance, it may seem odd that the <code class="docutils literal notranslate"><span class="pre">word-def</span></code> package, witch
is extended by plugins, it itself a dependency for its plugins. However,
this does not pose a problem.</p>
<p>Plugins are registered at running time, so the <code class="docutils literal notranslate"><span class="pre">word-def</span></code> package
is independent and can be installed without any plugins.</p>
<p>However, an issue arises if there are published plugins A and B:</p>
<ul class="simple">
<li><p>Plugin A uses <code class="docutils literal notranslate"><span class="pre">word-def</span></code> (v2.0)</p></li>
<li><p>Plugin B uses <code class="docutils literal notranslate"><span class="pre">word-def</span></code> (v1.0)</p></li>
</ul>
<p>If we try to install the latest versions of both plugins on the same machine,
it won’t work because they have incompatible dependencies. The only way to have
both plugins working would be to keep v1.0 of <code class="docutils literal notranslate"><span class="pre">word-def</span></code>.</p>
<div class="admonition-incompatible-dependency-issue admonition">
<p class="admonition-title">Incompatible dependency issue</p>
<p>This problem also exists in the design where we have the <code class="docutils literal notranslate"><span class="pre">word-def-core</span></code>
package.</p>
</div>
<p>This is not ideal. We would like to have both plugins with their latest versions
installed and if any issue appear, simply signalize to the user that that particular
plugin cannot be used.</p>
<p>To solve that issue, plugins should not specify the version of <code class="docutils literal notranslate"><span class="pre">word-def</span></code>
they depend on. Instead, the package manager (e.g. pip) will handle that.</p>
<div class="admonition-checking-version-compatibility admonition">
<p class="admonition-title">Checking version compatibility</p>
<p>It is always possible to check the plugin version and the <code class="docutils literal notranslate"><span class="pre">word-def</span></code> version. The
PluginFactory protocol specifies the method <code class="docutils literal notranslate"><span class="pre">version</span></code>, and the api has the methods
<code class="docutils literal notranslate"><span class="pre">api_version</span></code> and <code class="docutils literal notranslate"><span class="pre">is_plugin_compatible</span></code> for that purpose.</p>
</div>
</section>
</section>
</section>
<section id="plugin-register-mechanism">
<h3>Plugin register mechanism<a class="headerlink" href="#plugin-register-mechanism" title="Permalink to this heading"></a></h3>
<p><strong>Date: (2024-03-01)</strong></p>
<section id="id5">
<h4>Context<a class="headerlink" href="#id5" title="Permalink to this heading"></a></h4>
<p>We need a mechanism to register plugins such that <code class="docutils literal notranslate"><span class="pre">word-def</span></code>
can automatically identify and load them at runtime.</p>
<p><strong>Using a decorator</strong></p>
<p>The initial solution was to use a decorator and share the
burden with the plugin creator. In this scenario, the plugin
creator would have to add the <code class="docutils literal notranslate"><span class="pre">&#64;register</span></code> decorator to their
implementation of the <code class="docutils literal notranslate"><span class="pre">PluginFactory</span></code> class.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@model</span><span class="o">.</span><span class="n">register</span>
<span class="k">class</span><span class="w"> </span><span class="nc">AdapterFactory</span><span class="p">:</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>However, we still needed a way to automatically load the plugin
module at runtime. The second strategy allows us to do that
without burdening the plugin creator.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">singleton</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="n">instances</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_instance</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">cls</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
            <span class="n">instances</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">instances</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">get_instance</span>

<span class="nd">@singleton</span>
<span class="k">class</span><span class="w"> </span><span class="nc">_PluginRegister</span><span class="p">:</span>
    <span class="o">...</span>

<span class="k">def</span><span class="w"> </span><span class="nf">register</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">T_AdapterFactory</span><span class="p">):</span>
    <span class="n">plugin_register</span> <span class="o">=</span> <span class="n">_PluginRegister</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">inner</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">adapter_factory</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">plugin_register</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">adapter_factory</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">cls</span>
</pre></div>
</div>
<p><strong>Fixed plugin namespace and package introspection</strong></p>
<p>In this design, plugins must be within a fixed namespace: <code class="docutils literal notranslate"><span class="pre">danoan.word_def.modules.plugins</span></code>.
The <code class="docutils literal notranslate"><span class="pre">word-def</span></code> package can only identify and load Python modules located within this namespace.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">collect_modules</span><span class="p">():</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;danoan.word_def.plugins.modules&quot;</span>
        <span class="n">plugins_module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">module_info</span> <span class="ow">in</span> <span class="n">pkgutil</span><span class="o">.</span><span class="n">iter_modules</span><span class="p">(</span>
            <span class="n">plugins_module</span><span class="o">.</span><span class="n">__path__</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">):</span>
            <span class="k">yield</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">module_info</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">module_info</span><span class="o">.</span><span class="n">name</span>

</pre></div>
</div>
<p>The strong point of this approach is automatic loading. To start using a plugin,
the user only need to install the plugin package.</p>
<p>The drawback is the restriction on plugin creators to create their plugins
within a fixed namespace.</p>
</section>
<section id="id6">
<h4>Decision<a class="headerlink" href="#id6" title="Permalink to this heading"></a></h4>
<p>Use package introspection and Python import system mechanisms via <code class="docutils literal notranslate"><span class="pre">importlib</span></code>
to implement the plugin mechanism in <code class="docutils literal notranslate"><span class="pre">word-def</span></code>.</p>
</section>
<section id="id7">
<h4>Status<a class="headerlink" href="#id7" title="Permalink to this heading"></a></h4>
<p>Done.</p>
</section>
<section id="id8">
<h4>Consequences<a class="headerlink" href="#id8" title="Permalink to this heading"></a></h4>
<p>Plugin packages must be created within the namespace <code class="docutils literal notranslate"><span class="pre">danoan.word_def.modules.plugins</span></code>.</p>
</section>
</section>
<section id="testing-the-plugin-register-mechanism">
<h3>Testing the plugin register mechanism<a class="headerlink" href="#testing-the-plugin-register-mechanism" title="Permalink to this heading"></a></h3>
<p><strong>Date: (2024-03-02)</strong></p>
<section id="id9">
<h4>Context<a class="headerlink" href="#id9" title="Permalink to this heading"></a></h4>
<p>The plugin mechanism is designed to search and load modules in a given namespace. To
test this mechanism, we need to make the Python import system believe that there is
a <code class="docutils literal notranslate"><span class="pre">fake_test_plugin</span></code> python module in that namespace.</p>
<p>Our solution is to create a decorator that wraps the test function within a context manager.
Within the context manager, we create a temporary directory <code class="docutils literal notranslate"><span class="pre">T</span></code> and the directories
corresponding to our namespace. Finally, adding <code class="docutils literal notranslate"><span class="pre">T</span></code> to <code class="docutils literal notranslate"><span class="pre">sys.path</span></code> emulates the namespace at
runtime in the Python import system.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">plugin_context</span><span class="p">(</span><span class="n">plugins_location</span><span class="p">,</span> <span class="n">plugins_base_import_path</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">inner</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tempdir</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tempdir</span><span class="p">)</span>

                <span class="c1"># Create &lt;tempdir&gt;/&lt;namespace_dir&gt;</span>
                <span class="c1"># Copy fake_module to &lt;tempdir&gt;/&lt;namespace_dir&gt;</span>

                <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inner</span>
    <span class="k">return</span> <span class="n">decorator</span>


<span class="k">def</span><span class="w"> </span><span class="nf">test_plugin_register</span><span class="p">():</span>
    <span class="n">plugins_location</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">SCRIPT_FOLDER</span><span class="si">}</span><span class="s2">/input&quot;</span>
    <span class="n">plugins_base_import_path</span> <span class="o">=</span> <span class="s2">&quot;danoan.word_def.plugins.modules&quot;</span>

    <span class="nd">@plugin_context</span><span class="p">(</span><span class="n">plugins_location</span><span class="p">,</span> <span class="n">plugins_base_import_path</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">inner</span><span class="p">():</span>
        <span class="n">register</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">get_register</span><span class="p">()</span>

        <span class="n">language_plugins</span> <span class="o">=</span> <span class="n">register</span><span class="o">.</span><span class="n">get_language_plugins</span><span class="p">(</span><span class="s2">&quot;eng&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">language_plugins</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="n">inner</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="id10">
<h4>Decision<a class="headerlink" href="#id10" title="Permalink to this heading"></a></h4>
<p>Wrap test functions within a context manager to emulate the plugins namespace.</p>
</section>
<section id="id11">
<h4>Status<a class="headerlink" href="#id11" title="Permalink to this heading"></a></h4>
<p>Done.</p>
</section>
<section id="id12">
<h4>Consequences<a class="headerlink" href="#id12" title="Permalink to this heading"></a></h4>
<p>None.</p>
</section>
</section>
<section id="multi-language-plugins-register-mechanism">
<h3>Multi-language plugins register mechanism<a class="headerlink" href="#multi-language-plugins-register-mechanism" title="Permalink to this heading"></a></h3>
<p><strong>Date: (2024-03-15)</strong></p>
<section id="id13">
<h4>Context<a class="headerlink" href="#id13" title="Permalink to this heading"></a></h4>
<p>Originally, plugins were designed to be exclusive to a certain language. An English
plugin would only respond to queries regarding the English language.</p>
<p>However, the <code class="docutils literal notranslate"><span class="pre">word-def-plugin-multilanguage-chatgpt</span></code> can handle several languages at
once by simple mentioning the language in the prompt. The language, in this case, is
a plugin parameter.</p>
<p>We did not want to change the <code class="docutils literal notranslate"><span class="pre">Plugin</span></code> or <code class="docutils literal notranslate"><span class="pre">PluginFactory</span></code> protocols, so
we decided that multi-language plugins will return an empty string for the <code class="docutils literal notranslate"><span class="pre">get_language</span></code>
method and that it is up to the <code class="docutils literal notranslate"><span class="pre">word-def</span></code> API to specify the language for the
multi-language plugin at runtime.</p>
<p>Every method of <code class="docutils literal notranslate"><span class="pre">word-def</span></code> API requires a language parameter. The language parameter is used
to find an available plugin to execute the task in the given language. Whenever the plugin
search begins, ensure the multi-language factory is wrapped in a wrapper class. This class
preserves the calls of every method of the multi-language factory, except
<code class="docutils literal notranslate"><span class="pre">get_language</span></code>, which is replaced with the user-specified language.</p>
</section>
<section id="id14">
<h4>Decision<a class="headerlink" href="#id14" title="Permalink to this heading"></a></h4>
<ul class="simple">
<li><p>Allow multi-language plugins.</p></li>
<li><p>An empty string as return value of <code class="docutils literal notranslate"><span class="pre">get_method</span></code> indicates a multi-language plugin.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">word-def</span></code> API wraps the multi-language factory and overwrites the <code class="docutils literal notranslate"><span class="pre">get_language</span></code> method
as needed.</p></li>
</ul>
</section>
<section id="id15">
<h4>Status<a class="headerlink" href="#id15" title="Permalink to this heading"></a></h4>
<p>Done.</p>
</section>
<section id="id16">
<h4>Consequences<a class="headerlink" href="#id16" title="Permalink to this heading"></a></h4>
<p>None.</p>
</section>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="api-reference.html" class="btn btn-neutral float-left" title="API Reference" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Daniel Martins Antunes.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>